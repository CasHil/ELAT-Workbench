<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8" />
    <title>ELAT Workbench</title>
    <link rel="shortcut icon" type="image/x-icon" href="icons/favicon.ico">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.1/toastr.min.css">

    <link href="style/font-awesome.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/jsstore@2.11.0/dist/jsstore.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsstore@2.11.0/dist/jsstore.worker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sqlweb@1.2.1/dist/sqlweb.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mvallet91/ELAT-Workbench/scripts/pako.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/0.5.7/chartjs-plugin-annotation.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400" rel="stylesheet">

</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light container-fluid">
        <a class="navbar-brand" href="https://mvallet91.github.io/ELAT/">
            <span><img src="img/logonav.png" width="30" alt="Logo"></span> edX Logfile Analysis Tool
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarText">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a class="nav-link" href="https://mvallet91.github.io/ELAT/docs/home/">Learn More</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="https://mvallet91.github.io/ELAT/docs/quickstart/">Quick Start</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="https://mvallet91.github.io/ELAT/docs/about/">About</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="https://github.com/mvallet91/ELAT-Workbench" ><i class="fa fa-github fa-2x" aria-hidden="true"></i></a>
                </li>
            </ul>
            <span class="navbar-brand">
                <a class="nav-link pull-right" href="https://www.tudelft.nl/ewi/over-de-faculteit/afdelingen/software-technology/web-information-systems/" ><img src="img/2000px-TU_Delft_Logo.svg.png" width="90px" ></a>
            </span>
        </div>
    </nav>

    <div id="loading" style="display: none"></div>

    <div class="row justify-content-md-center " style="margin-top:10px; ">
        <div class="col-xs-12 col-sm-10  ">
            <table id="tblGrid" class="table table-hover ">
                <caption style="text-align:center;padding:7px 0 7px 0;background:#00A6D6;color:white;font-size:18px;caption-side: top; ">
                    Course Details
                </caption>
                <thead>
                    <tr>
                        <th>Course Name</th>
                        <th>Start Time</th>
                        <th>End Time</th>
                        <th>Course Elements</th>
                        <th>Enrolled Students</th>
                        <th>Quiz Questions</th>
                        <th>Forum Interactions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <!-- FILE SYSTEM FIELDS /////////////////////////////////////////////////////////////////////// -->
    <div class="row justify-content-md-center " style="margin-top:10px; ">
        <div class="col-xs-12 col-sm-10  ">
            <button type="button" class="btn btn-primary" data-toggle="collapse" data-target="#uploadBoxes" aria-expanded="false"  aria-controls="uploadBoxes">
                Upload Files
            </button>
            <button type="button" class="btn btn-secondary float-right" onclick="deleteEverything()">
                Clear Database
            </button>
        </div>
        <div class="col-xs-12 col-sm-10  ">
            <div id="uploadBoxes" class="collapse">
                Select all metadata files:<br>
                <input type="file" id="filesInput" multiple >
                <output id="list"></output>
                <br><br>

                Select log files:<br>
                <input type="file" id="logFilesInput" multiple >
                <output id="listLogs"></output>

                <table id="progress_tab">
                </table>
                <table id="progress_time">
                </table>
                <table id="progress_bar">
                </table>
            </div>
        </div>
    </div>

    <div class="row justify-content-md-center " style="margin-top:10px; ">
        <div class="col-xs-12 col-sm-10  ">
            <table id="dbGrid" class="table table-hover ">
                <caption style="text-align:center;padding:7px 0 7px 0;background:#00A6D6;color:white;font-size:18px;caption-side: top; ">
                    Database Details
                </caption>
                <thead>
                    <tr>
                        <th>Course Name</th>
                        <th>General Session</th>
                        <th>Forum Sessions</th>
                        <th>Video Interactions</th>
                        <th>Submissions</th>
                        <th>Assessments</th>
                        <th>Quiz Sessions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <table id="indicatorGrid" class="table table-hover ">
                <caption style="text-align:center;padding:7px 0 7px 0;background:#00A6D6;color:white;font-size:18px;caption-side: top; ">
                    Main Indicators
                </caption>
                <thead>
                <tr>
                    <th>Completion Rate</th>
                    <th>Average Grade <br>(completed course)</th>
                    <th># of Students per<br> Enrollment Mode (E.M.)</th>
                    <th>Avg. Grade by E.M.</th>
                    <th>Avg. Time Spent<br> Watching Video</th>
                    <th>Students that watched<br> at least 1 video</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>

            <table id="dlGrid" class="table table-hover ">
                <caption style="text-align:center;padding:7px 0 7px 0;background:#00A6D6;color:white;font-size:18px;caption-side: top; ">
                    Database Downloads
                </caption>
                <thead>
                <tr>
                    <th>Table</th>
                    <th>General Session</th>
                    <th>Forum Sessions</th>
                    <th>Video Interactions</th>
                    <th>Submissions</th>
                    <th>Assessments</th>
                    <th>Quiz Sessions</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <th><button type="button" class="btn btn-primary btn-sm" id="dl_all">Download All</button></th>
                    <th><button type="button" class="btn btn-primary btn-sm" id="dl_sessions">Download</button></th>
                    <th><button type="button" class="btn btn-primary btn-sm" id="dl_forum">Download</button></th>
                    <th><button type="button" class="btn btn-primary btn-sm" id="dl_vid_sessions">Download</button></th>
                    <th><button type="button" class="btn btn-primary btn-sm" id="dl_submissions">Download</button></th>
                    <th><button type="button" class="btn btn-primary btn-sm" id="dl_assessments">Download</button></th>
                    <th><button type="button" class="btn btn-primary btn-sm" id="dl_quiz">Download</button></th>
                </tr>
                </tbody>
            </table>
            <button type="button" class="btn btn-primary btn-sm" data-toggle="collapse" data-target="#graphOptions" aria-expanded="false" >
                Graph Options
            </button>
            <div id="graphOptions" class="collapse">
                <br>
                <h6>Date Range</h6>
                <div class="form-check" >
                    <label class="form-check-label">
                        <input type="radio" class="form-check-input" name="optradio" value="allDates" onchange="getGraphElementMap(drawCharts)">
                        All uploaded files
                    </label>
                </div>
                <div class="form-check">
                    <label class="form-check-label">
                        <input type="radio" class="form-check-input" name="optradio" value="courseDates" onchange="getGraphElementMap(drawCharts)">
                        Only in official course dates
                    </label>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-md-center " style="margin-top:10px; ">
        <div class="col-xs-12 col-sm-11  ">
            <canvas id="barChart" width="400" height="120"></canvas>
            <div class="col text-right">
                <button type="button" class="btn btn-secondary btn-sm" id="save-btn-totals" onclick="exportChart('barChart')">Save Chart Image</button>
            </div>
            <br>
            <canvas id="lineChart" width="400" height="120"></canvas>
            <div class="col text-right">
                <button type="button" class="btn btn-secondary btn-sm" id="save-btn-counts" onclick="exportChart('lineChart')">Save Chart Image</button>
            </div>
        </div>
    </div>

    <script src = "https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src = "https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.15.0/umd/popper.min.js"></script>
    <script src = "https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src = "https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.1/toastr.min.js"></script>

    <script src="scripts/index.js"></script>

    <script>

        function getGraphElementMap(callback) {
            let graphElementMap = {};
            connection.runSql("SELECT * FROM webdata WHERE name = 'graphElements' ").then(function(result) {
                if (result.length === 1) {
                    graphElementMap = result[0]['object'];
                    callback(graphElementMap);
                } else {

                    let dateListChart = [];

                    let orderedSessions = {};
                    let orderedDurations = {};
                    let orderedStudents = {};
                    let orderedAvgDurations = {};

                    let orderedQuizSessions = {};
                    let orderedQuizDurations = {};

                    let orderedVideoSessions = {};
                    let orderedVideoDurations = {};

                    let start_date = '';
                    let end_date = '';
                    let course_name = '';

                    let query = "SELECT * FROM courses";
                    connection.runSql(query).then(function (courses) {

                        courses.forEach(function (course) {
                            course_name = course['course_name'];
                            start_date = course['start_time'].toDateString();
                            end_date = course['end_time'].toDateString();

                            query = "SELECT * FROM sessions";
                            connection.runSql(query).then(function (sessions) {
                                let dailySessions = {};
                                let dailyDurations = {};

                                let quizSessions = {};
                                let quizDurations = {};

                                let videoSessions = {};
                                let videoDurations = {};

                                toastr.info('Processing indicators');

                                $('#loading').show();

                                sessions.forEach(function (session) {

                                    let start = session["start_time"].toDateString();
                                    start = new Date(start);

                                    if (dailyDurations.hasOwnProperty(start)) {

                                        dailyDurations[start].push(session["duration"]);
                                        dailySessions[start].push(session["course_learner_id"]);

                                    } else {
                                        dailyDurations[start] = [];
                                        dailyDurations[start].push(session["duration"]);

                                        dailySessions[start] = [];
                                        dailySessions[start].push(session["course_learner_id"]);
                                    }
                                });

                                query = "SELECT * FROM quiz_sessions";
                                connection.runSql(query).then(function (q_sessions) {
                                    q_sessions.forEach(function (session) {
                                        let start = session["start_time"].toDateString();
                                        start = new Date(start);

                                        if (quizDurations.hasOwnProperty(start)) {

                                            quizDurations[start].push(session["duration"]);
                                            quizSessions[start].push(session["course_learner_id"]);

                                        } else {
                                            quizDurations[start] = [];
                                            quizDurations[start].push(session["duration"]);

                                            quizSessions[start] = [];
                                            quizSessions[start].push(session["course_learner_id"]);
                                        }
                                    });

                                    query = "SELECT * FROM video_interaction";
                                    connection.runSql(query).then(function (v_sessions) {
                                        v_sessions.forEach(function (session) {
                                            let start = session["start_time"].toDateString();
                                            start = new Date(start);

                                            if (videoDurations.hasOwnProperty(start)) {

                                                videoDurations[start].push(session["duration"]);
                                                videoSessions[start].push(session["course_learner_id"]);

                                            } else {
                                                videoDurations[start] = [];
                                                videoDurations[start].push(session["duration"]);

                                                videoSessions[start] = [];
                                                videoSessions[start].push(session["course_learner_id"]);
                                            }
                                        });

                                        let dueDates = [];
                                        query = "SELECT * FROM quiz_questions";
                                        connection.runSql(query).then(function (questions) {
                                            questions.forEach(function (question) {
                                                dueDates.push(question['question_due'].toDateString())
                                            });

                                            let quizDates = Array.from(new Set(dueDates));
                                            let annotations = quizDates.map(function (date, index) {
                                                return {
                                                    type: 'line',
                                                    id: 'line' + index,
                                                    mode: 'vertical',
                                                    scaleID: 'x-axis-0',
                                                    value: new Date(date),
                                                    borderColor: 'red',
                                                    borderWidth: 1,
                                                    label: {
                                                        enabled: true,
                                                        position: "top",
                                                        content: 'quiz'
                                                    }
                                                }
                                            });

                                            let dateList = Object.keys(dailySessions);
                                            dateList.sort(function (a, b) {
                                                return new Date(a) - new Date(b);
                                            });

                                            for (let date of dateList) {
                                                orderedSessions[date] = dailySessions[date].length;
                                                orderedStudents[date] = new Set(dailySessions[date]).size;
                                                orderedDurations[date] = dailyDurations[date];
                                                if (quizSessions.hasOwnProperty(date)) {
                                                    orderedQuizSessions[date] = quizSessions[date].length;
                                                } else {
                                                    orderedQuizSessions[date] = 0
                                                }

                                                if (videoSessions.hasOwnProperty(date)) {
                                                    orderedVideoSessions[date] = videoSessions[date].length;
                                                } else {
                                                    orderedVideoSessions[date] = 0
                                                }

                                                let total = 0;
                                                for (let i = 0; i < dailyDurations[date].length; i++) {
                                                    total += dailyDurations[date][i];
                                                }
                                                orderedAvgDurations[date] = (total / dailyDurations[date].length).toFixed(2);

                                                let quizTotal = 0;
                                                for (let i = 0; i < orderedQuizSessions[date]; i++) {
                                                    quizTotal += quizDurations[date][i];
                                                }
                                                orderedQuizDurations[date] = quizTotal / orderedQuizSessions[date];

                                                let vidTotal = 0;
                                                for (let i = 0; i < orderedVideoSessions[date].length; i++) {
                                                    vidTotal += videoDurations[date][i];
                                                }
                                                orderedVideoDurations[date] = vidTotal / orderedVideoSessions[date].length;

                                                dateListChart.push(new Date(date));
                                            }

                                            graphElementMap = {
                                                'course_name': course_name,
                                                'start_date': start_date,
                                                'end_date': end_date,
                                                'dateListChart': dateListChart,
                                                'orderedSessions': orderedSessions,
                                                'orderedStudents': orderedStudents,
                                                'orderedDurations': orderedDurations,
                                                'orderedAvgDurations': orderedAvgDurations,
                                                'orderedQuizSessions': orderedQuizSessions,
                                                'orderedQuizDurations': orderedQuizDurations,
                                                'orderedVideoSessions': orderedVideoSessions,
                                                'orderedVideoDurations': orderedVideoDurations,
                                                'annotations': annotations
                                            };
                                            let graphElements = [{'name': 'graphElements', 'object': graphElementMap}];
                                            toastr.info('Processing graph data');
                                            sqlInsert('webdata', graphElements);
                                            callback(graphElementMap);
                                        });
                                    })
                                })
                            });
                        });
                    });
                }
            })
        }


        getGraphElementMap(drawCharts);

        let chart = null;
        let lineChart = null;

        function drawCharts(elementMap) {

            let canvas = document.getElementById('barChart');
            let ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // let ctx = document.getElementById('barChart').getContext('2d');
            // ctx.clearRect(0, 0,  document.getElementById('barChart').width,  document.getElementById('barChart').height);
            let endDate = new Date(elementMap['end_date']);
            let startDate = new Date(elementMap['start_date']);

            let data = {
                labels: elementMap['dateListChart'],
                datasets: [{
                    fill: false,
                    label: 'Total Students',
                    yAxisID: 'A',
                    data: Object.values(elementMap['orderedStudents']),
                    borderColor: '#FAB930',
                    backgroundColor: '#FAB930',
                    lineTension: 0.2,
                }, {
                    fill: false,
                    label: 'Total Sessions',
                    yAxisID: 'B',
                    data: Object.values(elementMap['orderedSessions']),
                    borderColor: '#12B1C7',
                    backgroundColor: '#12B1C7',
                    lineTension: 0.2,
                }]
            };

            let radioValue = $("input[name='optradio']:checked").val();
            if (radioValue){
                if (radioValue === 'allDates'){
                    startDate = new Date(elementMap['dateListChart'][0]);
                    endDate = new Date(elementMap['dateListChart'][elementMap['dateListChart'].length - 1]);
                }
            }

            let options = {
                type: 'line',
                data: data,
                title: elementMap['course_name'],
                options: {
                    fill: true,
                    responsive: true,
                    scales: {
                        xAxes: [{
                            type: 'time',
                            display: true,
                            time: {
                                unit: 'day',
                                min: startDate,
                                max: endDate
                            },
                            scaleLabel: {
                                display: true,
                                labelString: "Date",
                            }
                        }],
                        yAxes: [{
                            id: 'A',
                            ticks: {
                                beginAtZero: true,
                            },
                            position: 'left',
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: "Total Students",
                            }
                        }, {
                            id: 'B',
                            ticks: {
                                beginAtZero: true,
                            },
                            position: 'right',
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: "Total Sessions",
                            }
                        }]
                    }
                }
            };

            if (chart !== null) {
                chart.destroy();
            }

            chart = new Chart(ctx, options);

            let lineCtx = document.getElementById('lineChart').getContext('2d');

            let lineData = {
                labels: elementMap['dateListChart'],
                datasets: [{
                    fill: false,
                    label: 'Avg. Session Duration',
                    yAxisID: 'A',
                    data: Object.values(elementMap['orderedAvgDurations']),
                    borderColor: '#6EC5FB',
                    backgroundColor: '#6EC5FB',
                    lineTension: 0,
                }, {
                    fill: true,
                    label: 'Quiz Session Count',
                    yAxisID: 'B',
                    data: Object.values(elementMap['orderedQuizSessions']),
                    borderColor: '#13c70e',
                    backgroundColor: '#13c70e',
                    lineTension: 0,
                }, {
                    fill: true,
                    label: 'Video Session Count',
                    yAxisID: 'B',
                    data: Object.values(elementMap['orderedVideoSessions']),
                    borderColor: '#753599',
                    backgroundColor: '#753599',
                    lineTension: 0,
                }]
            };

            let lineOptions = {
                type: 'line',
                data: lineData,
                options: {

                    annotation: {
                        annotations: elementMap['annotations']
                    },

                    fill: false,
                    responsive: true,
                    scales: {
                        xAxes: [{
                            type: 'time',
                            display: true,
                            time: {
                                unit: 'day',
                                min: startDate,
                                max: endDate
                            },
                            scaleLabel: {
                                display: true,
                                labelString: "Date",
                            }
                        }],
                        yAxes: [{
                            id: 'A',
                            ticks: {
                                beginAtZero: true,
                            },
                            position: 'left',
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: "Duration in Seconds",
                            }
                        }, {
                            id: 'B',
                            stacked: true,
                            ticks: {
                                beginAtZero: true,
                            },
                            position: 'right',
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: "Number of Sessions",
                            }
                        }]
                    }
                }
            };

            if (lineChart !== null) {
                lineChart.destroy();
            }

            lineChart = new Chart(lineCtx, lineOptions);
        }

        function deleteEverything() {

            let query = 'DELETE FROM sessions';
            let r = confirm("WARNING!\nTHIS WILL DELETE EVERYTHING IN THE DATABASE");
            if (r === true) {
                connection.clear('sessions').then(function () {
                    console.log('Cleared sessions table');
                    connection.clear('video_interaction').then(function () {
                        console.log('Cleared video_interaction table');
                        connection.clear('submissions').then(function () {
                            console.log('Cleared submissions ');
                            connection.runSql(query).then(function () {
                                console.log('Cleared quiz_sessions ');
                                connection.clear('course_learner').then(function () {
                                    console.log('Cleared course_learner ');
                                    connection.clear('forum_sessions').then(function () {
                                        console.log('Cleared forum_sessions ');
                                        connection.dropDb().then(function(result){
                                            if (result === 1){alert('Database has been deleted!')}
                                        });
                                    }).catch(function (err) {
                                        console.log(err);
                                        alert('The deletion process started but did not finish,\n please refresh and try again');
                                    });
                                }).catch(function (err) {
                                    console.log(err);
                                    alert('The deletion process started but did not finish,\n please refresh and try again');
                                });
                            }).catch(function (err) {
                                console.log(err);
                                alert('The deletion process started but did not finish,\n please refresh and try again');
                            });
                        }).catch(function (err) {
                            console.log(err);
                            alert('The deletion process started but did not finish,\n please refresh and try again');
                        });
                    }).catch(function (err) {
                        console.log(err);
                        alert('The deletion process started but did not finish,\n please refresh and try again');
                    });
                }).catch(function (err) {
                    console.log(err);
                    alert('Could not delete database, please try again');
                });
            } else {
                alert('Nothing was deleted')
            }
        }

        // $("#save-btn").click(function() {
        //     $("#myChart").get(0).toBlob(function(blob) {
        //         saveAs(blob, "chart_1");
        //     });
        // });

        function exportChart(chartId) {
            document.getElementById(chartId).toBlob(function(blob) {
                // console.log(blob)
                let a = document.createElement('a');
                let filename = chartId;
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                a.click();
            });
        }
    </script>


    <!-- BRYTHON SCRIPT /////////////////////////////////////////////////////////////////////// -->
    <!--<script type="text/python" id="fileToMsg">-->
        <!--from browser import document, alert-->
        <!--import re-->
        <!--# bind event "click" on button to function echo-->

        <!--def echo(ev):-->
            <!--# message = document["zone"].value-->
            <!--# message = message * 5-->
            <!--message = document["fileDisplayArea"].innerText-->
            <!--# file_content = fileContent-->
            <!--message = message.split()-->
            <!--size = len(message[-1])-->
            <!--message = "Python read your file, the last word is: "" + str(message[-1]) + \-->
                      <!--""\nand it is " + str(size) + " characters long"-->
            <!--alert(message)-->

        <!--document["mybutton"].bind("click", echo)-->
    <!--</script>-->

    <!-- BRYTHON SCRIPT /////////////////////////////////////////////////////////////////////// -->
    <!--<script type="text/python" id="dbToMsg">-->
        <!--from browser import window, document, alert-->
        <!--import json-->
        <!--def echo_db(ev):-->
            <!--# window.connection.runSql("SELECT * FROM Student").then(window.function(result) {answer = result})-->
            <!--query_text =  document["query_zone"].value-->
            <!--window.sqlQuery(query_text)-->

        <!--def getResult(result):-->
            <!--query_result = json.loads(result.detail)-->
            <!--text_result = ""-->
            <!--for x in query_result:-->
                <!--for key in x:-->
                    <!--text_result = text_result + str(x[key]) + ", "-->
                <!--text_result = text_result + "\n"-->
            <!--document["queryDisplayArea"].innerText = text_result-->

        <!--document["action_button"].bind("click", echo_db)-->
        <!--document.bind("finishedQuery", getResult)-->
    <!--</script>-->
    <!-- BRYTHON SCRIPT /////////////////////////////////////////////////////////////////////// -->

    <!--<script type="text/python" id="fileToDb">-->
        <!--from browser import window, document, alert-->
        <!--import datetime, json-->
        <!--# import unicodedata-->

        <!--IDB = window.indexedDB-->
        <!--jq = window.jQuery-->

        <!--def cmp_datetime(a_datetime, b_datetime):-->
            <!--if a_datetime < b_datetime:-->
                <!--return -1-->
            <!--elif a_datetime > b_datetime:-->
                <!--return 1-->
            <!--else:-->
                <!--return 0-->


        <!--def getDayDiff(beginDate,endDate):-->
            <!--oneday = datetime.timedelta(days=1)-->
            <!--count = 0-->
            <!--while (endDate - beginDate) >= oneday:-->
                <!--endDate = endDate - oneday-->
                <!--count += 1-->
            <!--return count-->


        <!--def getNextDay(current_day_string):-->
            <!--format="%Y-%m-%d";-->
            <!--current_day = datetime.datetime.strptime(current_day_string,format)-->
            <!--oneday = datetime.timedelta(days=1)-->
            <!--next_day = current_day + oneday-->
            <!--return str(next_day)[0:10]-->


        <!--def process_null(inputString):-->
            <!--if isinstance(inputString, str):-->
                <!--if len(inputString)==0 or inputString=="NULL":-->
                    <!--return None-->
                <!--else:-->
                    <!--return inputString-->
            <!--return inputString-->


        <!--def ExtractCourseInformation(files):-->
            <!--course_metadata_map = {}-->

            <!--##### Edit for Brython #####-->
            <!--for file_name in files:-->
                <!--if "course_structure" in file_name:-->
                    <!--course_structure_file = files[file_name]-->
                    <!--##### Edit for Brython #####-->

                    <!--child_parent_map = {}-->
                    <!--element_time_map = {}-->
                    <!--# Add and element_time_map_due to record the due of sequential-->
                    <!--element_time_map_due = {}-->
                    <!--element_type_map = {}-->
                    <!--element_without_time = []-->

                    <!--quiz_question_map = {}-->
                    <!--block_type_map = {}-->

                    <!--##### Edit for Brython #####-->
                    <!--jsonObject = json.loads(course_structure_file)-->
                    <!--##### Edit for Brython #####-->

                    <!--for record in jsonObject:-->

                        <!--if jsonObject[record]["category"] == "course":-->

                            <!--# Course ID-->
                            <!--course_id = record-->
                            <!--if course_id.startswith("block-"):-->
                                <!--course_id = course_id.replace("block-","course-")-->
                                <!--course_id = course_id.replace("+type@course+block@course", "")-->
                            <!--if course_id.startswith("i4x://"):-->
                                <!--course_id = course_id.replace("i4x://", "")-->
                                <!--course_id = course_id.replace("course/", "")-->
                            <!--course_metadata_map["course_id"] = course_id-->

                            <!--# Course name-->
                            <!--course_name = jsonObject[record]["metadata"]["display_name"]-->
                            <!--course_metadata_map["course_name"] = course_name-->

                            <!--start_time = jsonObject[record]["metadata"]["start"]-->
                            <!--end_time = jsonObject[record]["metadata"]["end"]-->

                            <!--# Start & End data-->
                            <!--start_date = start_time[0:start_time.index("T")]-->
                            <!--end_date = end_time[0:end_time.index("T")]-->
                            <!--course_metadata_map["start_date"] = start_date-->
                            <!--course_metadata_map["end_date"] = end_date-->

                            <!--# Start & End time-->
                            <!--format="%Y-%m-%d %H:%M:%S"-->

                            <!--start_time = start_time[0:19]-->
                            <!--start_time = start_time.replace("T", " ")-->
                            <!--start_time = datetime.datetime.strptime(start_time,format)-->

                            <!--end_time = end_time[0:19]-->
                            <!--end_time = end_time.replace("T", " ")-->
                            <!--end_time = datetime.datetime.strptime(end_time,format)-->

                            <!--course_metadata_map["start_time"] = start_time-->
                            <!--course_metadata_map["end_time"] = end_time-->

                            <!--for child in jsonObject[record]["children"]:-->
                                <!--child_parent_map[child] = record-->
                            <!--element_time_map[record] = start_time-->

                            <!--element_type_map[record] = jsonObject[record]["category"]-->

                        <!--else:-->

                            <!--element_id = record-->

                            <!--# Child to parent relation-->
                            <!--for child in jsonObject[element_id]["children"]:-->
                                <!--child_parent_map[child] = element_id-->

                            <!--# Element time-->
                            <!--if "start" in jsonObject[element_id]["metadata"]:-->
                                <!--element_start_time = jsonObject[element_id]["metadata"]["start"]-->
                                <!--element_start_time = element_start_time[0:19]-->
                                <!--element_start_time = element_start_time.replace("T", " ")-->
                                <!--element_start_time = datetime.datetime.strptime(element_start_time,"%Y-%m-%d %H:%M:%S")-->
                                <!--element_time_map[element_id] = element_start_time-->
                            <!--else:-->
                                <!--element_without_time.append(element_id)-->

                            <!--# Element due time-->
                            <!--if "due" in jsonObject[element_id]["metadata"]:-->
                                <!--element_due_time = jsonObject[element_id]["metadata"]["due"]-->
                                <!--element_due_time = element_due_time[0:19]-->
                                <!--element_due_time = element_due_time.replace("T", " ")-->
                                <!--element_due_time = datetime.datetime.strptime(element_due_time,"%Y-%m-%d %H:%M:%S")-->
                                <!--element_time_map_due[element_id] = element_due_time-->

                            <!--# Element type-->
                            <!--element_type_map[element_id] = jsonObject[element_id]["category"]-->

                            <!--# Quiz questions-->
                            <!--if jsonObject[element_id]["category"] == "problem":-->
                                <!--# quiz_question_map.append(element_id)-->
                                <!--if "weight" in jsonObject[element_id]["metadata"]:-->
                                    <!--quiz_question_map[element_id] = jsonObject[element_id]["metadata"]["weight"]-->
                                <!--else:-->
                                    <!--# By default the weight is 1?-->
                                    <!--quiz_question_map[element_id] = 1.0-->

                            <!--# Types of blocks to which quiz questions belong-->
                            <!--if jsonObject[element_id]["category"] == "sequential":-->
                                <!--if "display_name" in jsonObject[element_id]["metadata"]:-->
                                    <!--block_type = jsonObject[element_id]["metadata"]["display_name"]-->
                                    <!--block_type_map[element_id] = block_type-->

                    <!--# Decide the start time for each element-->
                    <!--for element_id in element_without_time:-->
                        <!--element_start_time = ""-->
                        <!--while element_start_time == "":-->
                            <!--element_parent = child_parent_map[element_id]-->
                            <!--while not element_parent in element_time_map:-->
                                <!--element_parent = child_parent_map[element_parent]-->
                            <!--element_start_time = element_time_map[element_parent]-->
                        <!--element_time_map[element_id] = element_start_time-->

                    <!--######################################################-->
                    <!--############## Removing deleted elements #############-->
                    <!--######################################################-->
                    <!--# Here is a problem.-->
                    <!--# Some contents set before course start time are deleted-->
                    <!--# But some of them are reserved.-->
                    <!--#-->
                    <!--# Therefore, we cannot justify if an element deleted or not-->
                    <!--# just based on their creation time.-->
                    <!--# If there is a clear tag which shows whether-->
                    <!--# those elements are deleted or not, it would be better.-->
                    <!--#-->
                    <!--# For now, we keep all of them-->
                    <!--# and treat them as elements created in the 1st week.-->
                    <!--# &#45;&#45; Yue-->
                    <!--######################################################-->

                    <!--# for element_id in element_time_map.keys():-->
                    <!--#     if element_time_map[element_id] < course_metadata_map["start_time"]:-->
                    <!--#         element_time_map.pop(element_id)-->

                    <!--course_metadata_map["element_time_map"] = element_time_map-->
                    <!--course_metadata_map["element_time_map_due"] = element_time_map_due-->
                    <!--course_metadata_map["element_type_map"] = element_type_map-->
                    <!--course_metadata_map["quiz_question_map"] = quiz_question_map-->
                    <!--course_metadata_map["child_parent_map"] = child_parent_map-->
                    <!--course_metadata_map["block_type_map"] = block_type_map-->

                    <!--window.console.log("Metadata map ready")-->

                    <!--return course_metadata_map-->


        <!--def learner_mode(files):-->

            <!--##### Edit for Brython #####-->
            <!--report = []-->
            <!--course_record = []-->
            <!--course_element_record = []-->
            <!--learner_index_record = []-->
            <!--course_learner_record = []-->
            <!--learner_demographic_record = []-->

            <!--# Collect course information-->
            <!--report.append("Processing metadata map")-->
            <!--course_metadata_map = ExtractCourseInformation(files)-->

            <!--if course_metadata_map:-->
                <!--report.append("Metadata map ready")-->
                <!--course_record.append(-->
                    <!--[course_metadata_map["course_id"], course_metadata_map["course_name"],-->
                    <!--course_metadata_map["start_time"], course_metadata_map["end_time"]])-->

                <!--# Course_element table-->
                <!--# window.console.log("Processing " + str(len(course_metadata_map["element_time_map"].keys())) + \-->
                <!--#                    " elements in metadata map")-->
                <!--report.append("Processing " + str(len(course_metadata_map["element_time_map"].keys())) + \-->
                              <!--" elements in metadata map")-->
                <!--counter = 0-->
                <!--for element_id in course_metadata_map["element_time_map"].keys():-->
                    <!--element_start_time = course_metadata_map["element_time_map"][element_id]-->
                    <!--# Some contents released just one hour earlier than the hour of start time.-->
                    <!--# For example, start time is 2015-10-15 09:00:00, while 2nd week contents"-->
                    <!--# release time is 2015-10-22 08:00:00.-->
                    <!--# However, those 2nd week contents are count as 1st week.-->
                    <!--# In order to avoid above situation, I use date to replace datetime here.-->
                    <!--week = getDayDiff(course_metadata_map["start_time"].date(), element_start_time.date()) / 7 + 1-->

                    <!--array = [element_id, course_metadata_map["element_type_map"][element_id], week,-->
                             <!--course_metadata_map["course_id"]]-->
                    <!--course_element_record.append(array)-->

                    <!--if counter % (len(course_metadata_map["element_time_map"].keys())/5) == 0:-->
                        <!--report.append(str(counter) + " lines processed")-->
                    <!--counter += 1-->

                <!--report.append("Finished processing " + str(len(course_element_record)) +-->
                                   <!--" elements in metadata map")-->

                <!--# Learner_demographic table-->
                <!--learner_mail_map = {}-->

                <!--# Course_learner table-->
                <!--course_learner_map = {}-->
                <!--learner_enrollment_time_map = {}-->

                <!--# Enrolled learners set-->
                <!--enrolled_learner_set = set()-->

                <!--course_id = ""-->

                <!--# Processing student_courseenrollment data-->
                <!--##### Edit for Brython #####-->

                <!--for file_name in files:-->
                    <!--if "student_courseenrollment" in file_name:-->
                        <!--input_file = files[file_name]-->
                        <!--lines = input_file.split("\n")-->
                        <!--report.append("Starting course enrollment processing, for " + str(len(lines)) + " lines")-->
                        <!--counter = 0-->
                        <!--for line in lines[1:]:-->
                            <!--record = line.split("\t")-->

                            <!--if len(record) < 2:-->
                                <!--continue-->

                            <!--global_learner_id = record[1]-->
                            <!--course_id = record[2]-->
                            <!--time = datetime.datetime.strptime(record[3], "%Y-%m-%d %H:%M:%S")-->
                            <!--course_learner_id = course_id + "_" + global_learner_id-->

                            <!--if cmp_datetime(course_metadata_map["end_time"], time):-->
                                <!--enrolled_learner_set.add(global_learner_id)-->

                                <!--array = [global_learner_id, course_id, course_learner_id]-->
                                <!--learner_index_record.append(array)-->

                                <!--course_learner_map[global_learner_id] = course_learner_id-->
                                <!--learner_enrollment_time_map[global_learner_id] = time-->

                            <!--if counter % (len(lines)/5) == 0:-->
                                <!--report.append(str(counter)+ " lines processed")-->
                            <!--counter += 1-->

                        <!--report.append("The number of enrolled learners is: " + str(len(enrolled_learner_set)) + "\n")-->

                <!--for file_name in files:-->
                    <!--# Processing auth_user data ################################################################-->
                    <!--if "auth_user-" in file_name:-->
                        <!--input_file = files[file_name]-->
                        <!--lines = input_file.split("\n")-->
                        <!--report.append("Starting auth user pre-processing, for " + str(len(lines)) + " lines")-->

                        <!--for line in lines:-->
                            <!--record = line.split("\t")-->
                            <!--if record[0] in enrolled_learner_set:-->
                                <!--learner_mail_map[record[0]] = record[4]-->
                        <!--report.append("Done with auth user pre-processing with " + str(len(learner_mail_map)) +-->
                                           <!--" learners with email")-->

                <!--for file_name in files:-->
                    <!--# Processing certificates_generatedcertificate data ########################################-->
                    <!--num_uncertifiedLearners = 0-->
                    <!--num_certifiedLearners = 0-->
                    <!--counter = 0-->
                    <!--if "certificates_generatedcertificate" in file_name:-->
                        <!--input_file = files[file_name]-->
                        <!--lines = input_file.split("\n")-->
                        <!--report.append("Starting certificate processing, for " + str(len(lines)) + " lines")-->
                        <!--for line in lines:-->
                            <!--record = line.split("\t")-->
                            <!--if len(record) < 10:-->
                                <!--continue-->
                            <!--global_learner_id = record[1]-->

                            <!--final_grade = record[3]-->
                            <!--enrollment_mode = record[14].replace("\n", "")-->
                            <!--certificate_status = record[7]-->

                            <!--register_time = ""-->
                            <!--if global_learner_id in course_learner_map:-->
                                <!--register_time = learner_enrollment_time_map[global_learner_id]-->

                            <!--if global_learner_id in course_learner_map:-->
                                <!--num_certifiedLearners += 1-->
                                <!--array = [course_learner_map[global_learner_id], final_grade, enrollment_mode,-->
                                        <!--certificate_status, register_time]-->
                                <!--course_learner_record.append(array)-->
                            <!--else:-->
                                <!--num_uncertifiedLearners += 1-->

                            <!--if counter % (len(lines)/5) == 0:-->
                                <!--report.append(str(counter) + " lines processed")-->
                            <!--counter += 1-->

                        <!--report.append(str(num_certifiedLearners) + " certified learners and "+-->
                                           <!--str(num_uncertifiedLearners) + " uncertified learners")-->


                <!--for file_name in files:-->
                    <!--# Processing auth_userprofile data #######################################################-->
                    <!--if "auth_userprofile" in file_name:-->
                        <!--input_file = files[file_name]-->
                        <!--lines = input_file.split("\n")-->
                        <!--report.append("Starting auth userprofile processing, for " + str(len(lines)) + " lines")-->
                        <!--counter = 0-->
                        <!--for line in lines:-->
                            <!--record = line.split("\t")-->
                            <!--if len(record) < 10:-->
                                <!--continue-->
                            <!--global_learner_id = record[1]-->
                            <!--gender = record[7]-->
                            <!--year_of_birth = record[9]-->
                            <!--level_of_education = record[10]-->
                            <!--country = record[13]-->

                            <!--course_learner_id = course_id + "_" + global_learner_id-->

                            <!--if global_learner_id in enrolled_learner_set:-->
                                <!--array = [course_learner_id, gender, year_of_birth, level_of_education, country,-->
                                         <!--learner_mail_map[global_learner_id]]-->
                                <!--learner_demographic_record.append(array)-->

                            <!--if counter % (len(lines)/5) == 0:-->
                                <!--report.append(str(counter) + " lines processed")-->
                            <!--counter += 1-->

                        <!--report.append("Done with auth_userprofile " + str(len(learner_demographic_record)) +-->
                                           <!--" learner demographic records")-->


                <!--for file_name in files:-->
                    <!--# Processing forum data #######################################################-->
                    <!--if ".mongo" in file_name:-->
                        <!--forum_interaction_records = []-->

                        <!--forum_file = files[file_name]-->
                        <!--lines = forum_file.split("\n")-->

                        <!--for line in lines[:1155]:-->
                            <!--if len(line) < 9:-->
                                <!--continue-->
                            <!--jsonObject = json.loads(line)-->

                            <!--post_id = jsonObject["_id"]["$oid"]-->
                            <!--course_learner_id = jsonObject["course_id"] + "_" + jsonObject["author_id"]-->

                            <!--post_type = jsonObject["_type"]-->
                            <!--if post_type == "CommentThread":-->
                                <!--post_type += "_" + jsonObject["thread_type"]-->
                            <!--if "parent_id" in jsonObject and jsonObject["parent_id"] != "":-->
                                <!--post_type = "Comment_Reply"-->

                            <!--post_title = ""-->
                            <!--if "title" in jsonObject:-->
                                <!--post_title=jsonObject["title"]-->

                            <!--post_content = jsonObject["body"]-->

                            <!--post_timestamp = jsonObject["created_at"]["$date"]-->
                            <!--if type(post_timestamp) == type(100):-->
                                <!--post_timestamp = strftime("%Y-%m-%d %H:%M:%S",gmtime(post_timestamp/1000))-->
                                <!--post_timestamp = datetime.datetime.strptime(post_timestamp,"%Y-%m-%d %H:%M:%S")-->
                            <!--if isinstance(post_timestamp, str):-->
                                <!--post_timestamp = post_timestamp[0:19]-->
                                <!--post_timestamp = post_timestamp.replace("T", " ")-->
                                <!--post_timestamp = datetime.datetime.strptime(post_timestamp,"%Y-%m-%d %H:%M:%S")-->

                            <!--post_parent_id = ""-->
                            <!--if "parent_id" in jsonObject:-->
                                <!--post_parent_id = jsonObject["parent_id"]["$oid"]-->

                            <!--post_thread_id = ""-->
                            <!--if "comment_thread_id" in jsonObject:-->
                                <!--post_thread_id = jsonObject["comment_thread_id"]["$oid"]-->

                            <!--post_title = post_title.replace("\n", " ")-->
                            <!--post_title = post_title.replace("\\", "\\\\")-->
                            <!--post_title = post_title.replace("\'", "\\'")-->

                            <!--post_content = post_content.replace("\n", " ")-->
                            <!--post_content = post_content.replace("\\", "\\\\")-->
                            <!--# post_content = post_content.replace("\'", "\\'")-->
                            <!--post_content = post_content.replace('"', '\"')-->

                            <!--if post_timestamp < course_metadata_map["end_time"]:-->
                                <!--array = [post_id, course_learner_id, post_type, post_title, post_content, post_timestamp, post_parent_id, post_thread_id]-->
                                <!--forum_interaction_records.append(array)-->

                        <!--report.append("Done with forum_interaction " + str(len(forum_interaction_records)) +-->
                                       <!--" forum records")-->

                <!--report.append("All metadata ready")-->

                <!--if len(course_record) > 0:-->
                    <!--data = []-->
                    <!--for array in course_record:-->
                        <!--course_id = course_metadata_map["course_id"]-->
                        <!--course_name = course_metadata_map["course_name"]-->
                        <!--start_time = course_metadata_map["start_time"]-->
                        <!--end_time = course_metadata_map["end_time"]-->
                        <!--values = {"course_id": course_id, "course_name": course_name,-->
                                <!--"start_time": start_time.isoformat(),-->
                                <!--"end_time": end_time.isoformat()}-->
                        <!--data.append(values)-->
                    <!--window.sqlInsert("courses", data)-->
                <!--else:-->
                    <!--report.append("no courses info")-->

                <!--if len(course_element_record) > 0:-->
                    <!--data = []-->
                    <!--for array in course_element_record:-->
                        <!--element_id = array[0]-->
                        <!--element_type = array[1]-->
                        <!--week = process_null(array[2])-->
                        <!--course_id = array[3]-->
                        <!--values = {"element_id": element_id, "element_type": element_type,-->
                                  <!--"week": week, "course_id": course_id}-->
                        <!--data.append(values)-->
                    <!--window.sqlInsert("course_elements", data)-->
                <!--else:-->
                    <!--report.append("no course element info")-->

                <!--if len(learner_index_record) > 0:-->
                    <!--data = []-->
                    <!--for array in learner_index_record:-->
                        <!--global_learner_id = array[0]-->
                        <!--course_id = array[1]-->
                        <!--course_learner_id = array[2]-->
                        <!--values = {"global_learner_id": global_learner_id, "course_id":course_id,-->
                                   <!--"course_learner_id":course_learner_id}-->
                        <!--data.append(values)-->
                    <!--window.sqlInsert("learner_index", data)-->
                <!--else:-->
                    <!--report.append("no learner index info")-->

                <!--if len(course_learner_record) > 0:-->
                    <!--data = []-->
                    <!--report.append("Storing " + str(len(course_learner_record)) +-->
                                      <!--" learner records in DB")-->
                    <!--for array in course_learner_record:-->
                        <!--course_learner_id = array[0]-->
                        <!--try:-->
                            <!--final_grade = float(process_null(array[1]))-->
                        <!--except TypeError:-->
                            <!--final_grade = process_null(array[1])-->
                        <!--enrollment_mode = array[2]-->
                        <!--certificate_status = array[3]-->
                        <!--register_time = process_null(array[4])-->
                        <!--values = {"course_learner_id": course_learner_id, "final_grade": final_grade,-->
                                  <!--"enrollment_mode":enrollment_mode, "certificate_status": certificate_status,-->
                                  <!--"register_time": register_time}-->
                        <!--data.append(values)-->
                    <!--window.sqlInsert("course_learner", data)-->
                <!--else:-->
                    <!--report.append("no enrolled students info")-->

                <!--if len(learner_demographic_record) > 0:-->
                    <!--data = []-->
                    <!--report.append("Storing " + str(len(learner_demographic_record)) +-->
                                      <!--" demographic records in DB")-->
                    <!--for array in learner_demographic_record:-->
                        <!--course_learner_id = process_null(array[0])-->
                        <!--gender = array[1]-->
                        <!--try:-->
                            <!--year_of_birth = int(process_null(process_null(array[2])))-->
                        <!--except TypeError:-->
                            <!--year_of_birth = process_null(process_null(array[2]))-->
                        <!--level_of_education = array[3]-->
                        <!--country = array[4]-->
                        <!--email = array[5]-->
                        <!--email = email.replace("\"", "")-->
                        <!--values = {"course_learner_id": course_learner_id, "gender": gender,-->
                                  <!--"year_of_birth": year_of_birth, "level_of_education": level_of_education,-->
                                  <!--"country": country, "email": email}-->
                        <!--data.append(values)-->
                    <!--window.sqlInsert("learner_demographic", data)-->
                <!--else:-->
                    <!--report.append("no learner demographic info")-->

                <!--if len(forum_interaction_records) > 0:-->
                    <!--data = []-->
                    <!--report.append("Storing " + str(len(forum_interaction_records)) +-->
                                      <!--" forum interaction records in DB")-->
                    <!--for array in forum_interaction_records:-->
                        <!--post_id = array[0]-->
                        <!--course_learner_id = array[1]-->
                        <!--post_type = array[2]-->
                        <!--post_title = window.cleanUnicode(array[3])-->
                        <!--post_content = window.cleanUnicode(array[4])-->
                        <!--post_timestamp = array[5]-->
                        <!--post_parent_id = array[6]-->
                        <!--post_thread_id = array[7]-->
                        <!--values = {"post_id": post_id, "course_learner_id": course_learner_id,-->
                                  <!--"post_type": post_type, "post_title": post_title,-->
                                  <!--"post_content": post_content, "post_timestamp":post_timestamp.isoformat(),-->
                                  <!--"post_parent_id": post_parent_id, "post_thread_id":post_thread_id}-->
                        <!--data.append(values)-->
                    <!--window.sqlInsert("forum_interaction", data)-->
                <!--else:-->
                    <!--report.append("no forum interaction info")-->


                <!--map_to_store = course_metadata_map-->
                <!--map_to_store["start_time"] = start_time.isoformat()-->
                <!--map_to_store["end_time"] = end_time.isoformat()-->
                <!--for element in map_to_store["element_time_map"]:-->
                    <!--map_to_store["element_time_map"][element] = course_metadata_map["element_time_map"][element].isoformat()-->
                <!--for element in map_to_store["element_time_map_due"]:-->
                    <!--map_to_store["element_time_map_due"][element] = course_metadata_map["element_time_map_due"][element].isoformat()-->
                <!--store_map = [{"name": "metadata_map",-->
                             <!--"object": map_to_store}]-->
                <!--window.sqlInsert("metadata", store_map)-->
                <!--jq("#loading").hide()-->

                <!--if window.confirm("Download processing report?"):-->
                    <!--report = "\n".join(report)-->
                    <!--window.download("report.txt", report)-->
                    <!--alert("Your data is being stored, please wait a couple minutes before reloading this page")-->
                <!--else:-->
                    <!--window.console.log("No report downloaded")-->
                    <!--alert("Your data is being stored, please wait a couple minutes before reloading this page")-->

            <!--else:-->
                <!--report.append("Course structure file not found")-->
                <!--jq("#loading").hide()-->

                <!--if window.confirm("Download processing report?"):-->
                    <!--report = "\n".join(report)-->
                    <!--window.download("report.txt", report)-->
                <!--else:-->
                    <!--window.console.log("No report downloaded")-->


        <!--def getFiles(result):-->
            <!--files = {}-->
            <!--pairs = json.loads(result.detail)-->
            <!--for pair in pairs:-->
                <!--file_name = pair["key"]-->
                <!--file = pair["value"]-->
                <!--files[file_name] = file-->
            <!--return files-->


        <!--def metadata_processing(results):-->
            <!--files = getFiles(results)-->
            <!--window.console.log("Files ready")-->
            <!--learner_mode(files)-->


        <!--def cleanUnicode(text):-->
            <!--#return text;-->
            <!--if isinstance(text, str):-->
                <!--# return unicodedata.normalize("NFC", text);-->
                <!--window.text.normalize("NFC")-->
            <!--else:-->
                <!--return text-->
            <!--#return unicodedata.normalize("NFKD", text).encode("utf8", "ignore");-->


        <!--# for detecting mentioned element info in the log-->
        <!--def courseElementsFinder(eventlog, course_id):-->
            <!--elementsID = ""-->
            <!--elementsID = coucourseElementsFinder_string(eventlog["event_type"], course_id)-->
            <!--if elementsID == "":-->
                <!--elementsID = coucourseElementsFinder_string(eventlog["path"], course_id)-->
            <!--if elementsID == "":-->
                <!--elementsID = coucourseElementsFinder_string(eventlog["page"], course_id)-->
            <!--if elementsID == "":-->
                <!--elementsID = coucourseElementsFinder_string(eventlog["referer"], course_id)-->
            <!--return elementsID-->


        <!--def coucourseElementsFinder_string(eventlog_item, course_id):-->
            <!--elementsID = ""-->
            <!--courseId_filtered = course_id.split(":")[1]-->

            <!--if elementsID == "" and "+type@" in eventlog_item and "block-v1:" in eventlog_item:-->
                <!--templist = eventlog_item.split("/")-->
                <!--for tempstring in templist:-->
                    <!--if "+type@" in tempstring and "block-v1:" in tempstring:-->
                        <!--elementsID = tempstring-->

            <!--if elementsID == "" and "courseware/" in eventlog_item:-->
                <!--templist = eventlog_item.split("/")-->
                <!--tempflag = False-->
                <!--for tempstring in templist:-->
                    <!--if tempstring == "courseware":-->
                        <!--tempflag = True-->
                    <!--else:-->
                        <!--if tempflag is True and tempstring != "":-->
                            <!--elementsID = ("block-v1:" +-->
                                          <!--courseId_filtered +-->
                                          <!--"+type@chapter+block@" +-->
                                          <!--tempstring)-->
                            <!--break-->

            <!--return elementsID-->

        <!--request = IDB.open("edxdb")-->

        <!--document.bind("studentMetaReader", metadata_processing)-->


    <!--</script>-->
    <!-- BRYTHON SCRIPT /////////////////////////////////////////////////////////////////////// -->
    <!--<script type="text/python" id="logToDb">-->
        <!--from browser import window, document, alert-->
        <!--import datetime, json, time-->
        <!--from operator import itemgetter-->

        <!--IDB = window.indexedDB-->
        <!--jq = window.jQuery-->

        <!--def cmp_datetime(a_datetime, b_datetime):-->
            <!--if a_datetime < b_datetime:-->
                <!--return -1-->
            <!--elif a_datetime > b_datetime:-->
                <!--return 1-->
            <!--else:-->
                <!--return 0-->


        <!--def getDayDiff(beginDate,endDate):-->
            <!--oneday = datetime.timedelta(days=1)-->
            <!--count = 0-->
            <!--while (endDate - beginDate) >= oneday:-->
                <!--endDate = endDate - oneday-->
                <!--count += 1-->
            <!--return count-->


        <!--def getNextDay(current_day_string):-->
            <!--format="%Y-%m-%d";-->
            <!--current_day = datetime.datetime.strptime(current_day_string,format)-->
            <!--oneday = datetime.timedelta(days=1)-->
            <!--next_day = current_day + oneday-->
            <!--return str(next_day)[0:10]-->


        <!--def process_null(inputString):-->
            <!--if isinstance(inputString, str):-->
                <!--if len(inputString)==0 or inputString=="NULL":-->
                    <!--return None-->
                <!--else:-->
                    <!--return inputString-->
            <!--return inputString-->


        <!--def session_mode(log_files, course_metadata_map, index, total, chunk):-->

            <!--current_date = course_metadata_map["start_date"]-->
            <!--end_next_date = getNextDay(course_metadata_map["end_date"])-->

            <!--learner_all_event_logs = {}-->
            <!--updated_learner_all_event_logs = {}-->
            <!--session_record = []-->

            <!--# if current_date == end_next_date:-->
            <!--#     break-->

            <!--#####################################################################-->
            <!--for file_name in log_files:-->
                <!--if "log" in file_name:-->
                    <!--start = datetime.datetime.now()-->
                    <!--counter = 0-->
                    <!--# if current_date in file_name:-->

                    <!--print("Starting chunk " + str(chunk) + " in Python at " + str(datetime.datetime.now().time()))-->
                    <!--print((datetime.datetime.now() - start).total_seconds())-->
                    <!--# document["progress_tab"] <= file_name + "\n"-->
                    <!--# window.progress_display(file_name)-->

                    <!--learner_all_event_logs.clear()-->
                    <!--learner_all_event_logs = updated_learner_all_event_logs.copy()-->
                    <!--updated_learner_all_event_logs.clear()-->

                    <!--# Course_learner_id set-->
                    <!--course_learner_id_set = set()-->
                    <!--for course_learner_id in learner_all_event_logs.keys():-->
                        <!--course_learner_id_set.add(course_learner_id)-->

                    <!--input_file = log_files[file_name]-->
                    <!--lines = input_file.split("\n")-->
                    <!--print(str(len(lines)) + " lines to process in file")-->
                    <!--print((datetime.datetime.now() - start).total_seconds())-->

                    <!--new_line_reader = ["new_line_reader"]-->
                    <!--existing_line_reader = ["existing_line_reader"]-->

                    <!--for line in lines[0:10000]:-->
                        <!--start = datetime.datetime.now()-->

                        <!--if len(line) < 10:-->
                            <!--print("Skipped line")-->
                            <!--continue-->
                        <!--jsonObject = json.loads(line)-->

                        <!--if "user_id" not in jsonObject["context"]:-->
                            <!--print("no userid")-->
                            <!--continue-->

                        <!--global_learner_id = jsonObject["context"]["user_id"]-->
                        <!--event_type = str(jsonObject["event_type"])-->

                        <!--if global_learner_id != "":-->
                            <!--course_id = jsonObject["context"]["course_id"]-->
                            <!--course_learner_id = course_id + "_" + str(global_learner_id)-->

                            <!--event_time = jsonObject["time"]-->
                            <!--event_time = event_time[0:19]-->
                            <!--event_time = event_time.replace("T", " ")-->
                            <!--event_time = datetime.datetime.strptime(event_time,"%Y-%m-%d %H:%M:%S")-->

                            <!--if course_learner_id in course_learner_id_set:-->
                                <!--learner_all_event_logs[course_learner_id].append({"event_time":event_time, "event_type":event_type})-->
                                <!--existing_line_reader.append((datetime.datetime.now() - start).total_seconds())-->
                            <!--else:-->
                                <!--learner_all_event_logs[course_learner_id] = [{"event_time":event_time, "event_type":event_type}]-->
                                <!--course_learner_id_set.add(course_learner_id)-->
                                <!--new_line_reader.append((datetime.datetime.now() - start).total_seconds())-->

                        <!--### Counter #############################################-->
                        <!--# if counter % 10000 == 0:-->
                        <!--#     counter_message = (str(counter) + " lines processed in " +-->
                        <!--#                        str(time.time() - start))-->
                        <!--#     print(counter_message)-->
                        <!--#     document["progress_tab"] <= counter_message + "\n"-->
                        <!--#     window.progress_display(counter_message)-->
                        <!--# counter += 1-->
                        <!--### Counter #############################################-->

                    <!--print("id list ready, with size: ", len(learner_all_event_logs),-->
                                        <!--" at ", str(datetime.datetime.now().time()) )-->
                    <!--print((datetime.datetime.now() - start).total_seconds())-->
                    <!--counter = 0-->
                    <!--sorter = ["sorter"]-->
                    <!--starting_event = ["starting_event"]-->
                    <!--cont_event_a = ["cont_event_a"]-->
                    <!--cont_event_b = ["cont_event_b"]-->

                    <!--for course_learner_id in learner_all_event_logs.keys():-->
                        <!--start = datetime.datetime.now()-->
                        <!--event_logs = learner_all_event_logs[course_learner_id]-->

                        <!--# Sorting-->
                        <!--# REVISED from #event_logs.sort(cmp=cmp_datetime, key=operator.itemgetter("event_time"))-->

                        <!--event_logs = sorted(event_logs, key=itemgetter("event_time"))-->
                        <!--sorter.append((datetime.datetime.now() - start).total_seconds())-->
                        <!--session_id = ""-->
                        <!--start_time = ""-->
                        <!--end_time = ""-->

                        <!--final_time = ""-->

                        <!--for i in range(len(event_logs)):-->
                            <!--start = datetime.datetime.now()-->
                            <!--if start_time == "":-->
                                <!--# Initialization-->
                                <!--start_time = event_logs[i]["event_time"]-->
                                <!--end_time = event_logs[i]["event_time"]-->

                                <!--starting_event.append((datetime.datetime.now() - start).total_seconds())-->

                            <!--else:-->

                                <!--if event_logs[i]["event_time"] > end_time + datetime.timedelta(hours=0.5):-->


                                    <!--session_id = course_learner_id + "_" + str(start_time) + "_" + str(end_time)-->
                                    <!--duration = (end_time - start_time).days * 24 * 60 * 60 + (end_time - start_time).seconds-->

                                    <!--if duration > 5:-->
                                        <!--array = [session_id, course_learner_id, start_time, end_time, duration]-->
                                        <!--session_record.append(array)-->

                                    <!--final_time = event_logs[i]["event_time"]-->

                                    <!--# Re-initialization-->
                                    <!--session_id = ""-->
                                    <!--start_time = event_logs[i]["event_time"]-->
                                    <!--end_time = event_logs[i]["event_time"]-->
                                    <!--cont_event_a.append((datetime.datetime.now() - start).total_seconds())-->

                                <!--else:-->
                                    <!--if event_logs[i]["event_type"] == "page_close":-->

                                        <!--end_time = event_logs[i]["event_time"]-->

                                        <!--session_id = course_learner_id + "_" + str(start_time) + "_" + str(end_time)-->
                                        <!--duration = (end_time - start_time).days * 24 * 60 * 60 + (end_time - start_time).seconds-->

                                        <!--if duration > 5:-->
                                            <!--array = [session_id, course_learner_id, start_time, end_time, duration]-->
                                            <!--session_record.append(array)-->

                                        <!--# Re-initialization-->
                                        <!--session_id = ""-->
                                        <!--start_time = ""-->
                                        <!--end_time = ""-->

                                        <!--final_time = event_logs[i]["event_time"]-->

                                    <!--else:-->

                                        <!--end_time = event_logs[i]["event_time"]-->

                                    <!--cont_event_b.append((datetime.datetime.now() - start).total_seconds())-->

                        <!--if final_time != "":-->
                            <!--new_logs = []-->
                            <!--for log in event_logs:-->
                                <!--if log["event_time"] >= final_time:-->
                                    <!--new_logs.append(log)-->

                            <!--updated_learner_all_event_logs[course_learner_id] = new_logs-->

                        <!--### Counter #############################################-->
                        <!--# if counter % 1000 == 0:-->
                        <!--#     print(str(counter) + " lines processed in " +-->
                        <!--#                        str(time.time() - start))-->
                        <!--# counter += 1-->
                        <!--### Counter #############################################-->

            <!--current_date = getNextDay(current_date)-->
            <!--# Filter duplicated records-->
            <!--print("Filtering duplicated records at " + str(datetime.datetime.now().time()))-->
            <!--print("Total", (datetime.datetime.now() - start).total_seconds())-->
            <!--updated_session_record = []-->
            <!--session_id_set = set()-->
            <!--for array in session_record:-->
                <!--session_id = array[0]-->
                <!--if session_id not in session_id_set:-->
                    <!--session_id_set.add(session_id)-->
                    <!--updated_session_record.append(array)-->

            <!--session_record = updated_session_record-->
            <!--window.download("lists.txt", [new_line_reader, "\n", existing_line_reader, "\n", sorter, "\n",-->
                                           <!--starting_event, "\n", cont_event_a, "\n", cont_event_b])-->
            <!--print("Session data processed at " + str(datetime.datetime.now().time()))-->
            <!--print((datetime.datetime.now() - start).total_seconds())-->
            <!--if len(session_record) > 0:-->
                <!--print("Session data to store: ", len(session_record))-->
                <!--data = []-->
                <!--for array in session_record:-->
                    <!--session_id = array[0]-->
                    <!--course_learner_id = array[1]-->
                    <!--start_time = array[2]-->
                    <!--end_time = array[3]-->
                    <!--duration = process_null(array[4])-->
                    <!--values = {"session_id":session_id, "course_learner_id":course_learner_id,-->
                              <!--"start_time":start_time.isoformat(),-->
                              <!--"end_time": end_time.isoformat(), "duration":duration}-->
                    <!--data.append(values)-->
                <!--print("Send to storage at " + str(datetime.datetime.now().time()))-->
                <!--# window.sqlLogInsert("sessions", data)-->
                <!--print("not storing for test, CHANGE", index, total, chunk)-->
                <!--print("Total", (datetime.datetime.now() - start).total_seconds())-->
                <!--chunk = chunk + 1-->
                <!--document["progress_bar"] <= str(chunk) + " - "-->

                <!--if len(lines) < 1001:-->
                    <!--chunk = 0-->
                    <!--window.progress_display("Done with file " + str(index + 1))-->
                    <!--index = index + 1-->
                <!--if index < total:-->
                    <!--print("Back to JS at " + str(datetime.datetime.now().time()))-->
                    <!--window.processLogFiles(index, chunk)-->
                <!--else:-->
                    <!--alert("Done")-->

            <!--else:-->
                <!--print("no session info", index, total)-->

            <!--jq("#loading").hide()-->


        <!--def getFiles(result):-->
            <!--meta_map = result.detail[0]-->
            <!--meta_map = meta_map[0]["object"]-->
            <!--files = {}-->
            <!--# pairs = json.loads(result.detail[1])-->
            <!--pairs = result.detail[1]-->
            <!--index = result.detail[2] # + 1-->
            <!--total = result.detail[3]-->
            <!--chunk = result.detail[4]-->
            <!--for pair in pairs:-->
                <!--file_name = pair["key"]-->
                <!--file = pair["value"]-->
                <!--files[file_name] = file-->
            <!--return files, meta_map, index, total, chunk-->


        <!--def process_logs(result):-->
            <!--files, meta_map, index, total, chunk = getFiles(result)-->
            <!--print("Files ready")-->
            <!--session_mode(files, meta_map, index, total, chunk)-->

        <!--document.bind("logFileReader", process_logs)-->

    <!--</script>-->

    <link href="style/main.css " rel="stylesheet " type="text/css " />
</body>

</html>