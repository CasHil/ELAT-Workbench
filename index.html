<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8" />
    <title>Testing JsStore + SqlWeb + File Manager</title>
    <link rel="shortcut icon" type="image/x-icon" href="icons/favicon.ico">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <script src="scripts/jquery.js"></script>
    <link rel="stylesheet" type="text/css" href="style/bootstrap.css" />
    <script src="scripts/bootstrap.js"></script>
    <link rel="stylesheet" href="style/font-awesome.min.css" />
    <script src="scripts/jsstore.js "></script>
    <script src="scripts/sqlweb.js"></script>

    <script src="brython/brython.js"></script>

    <!--<script data-main="scripts/index" src="scripts/require.js"></script>-->
    <script data-main="scripts/index" src="https://cdn.jsdelivr.net/gh/mvallet91/untitled/scripts/require.js"></script>

    <script type="text/javascript" src="brython/brython_stdlib.js"></script>

    <!--<script src="scripts/pako.js"></script>-->
    <script src="https://cdn.jsdelivr.net/gh/mvallet91/untitled/scripts/pako.js"></script>

    <script src="scripts/index.js"></script>
</head>

<body>
    <div class="row row-centered " style="margin-top:10px; ">
        <div class="col-xs-12 col-sm-10 col-centered ">
            <div style="text-align:center;">
                <button id="btnAddStudent" class="btn btn-success">
                    <i class="fa fa-plus" aria-hidden="true"></i> Add Student</button>
            </div>
            <table id="tblGrid" class="table table-hover ">
                <caption style="text-align:center;padding:7px 0 7px 0;background:#4f4f86;color:white;font-family:cursive;font-size:18px; ">Student's
                    Details</caption>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Gender</th>
                        <th>Country</th>
                        <th>City</th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <!-- FILE SYSTEM FIELDS /////////////////////////////////////////////////////////////////////// -->
    <div>
        Select a text file:
        <input type="file" id="fileInput" multiple>
        <button id="mybutton">Click to process text file!</button>
        <pre id="fileDisplayArea"></pre>
    </div>

    <div>
        <input id="query_zone" value="SELECT * FROM Student WHERE Country = 'Canada'" size="50">
        <button id="action_button">Click to run query in db</button>
        <pre id="queryDisplayArea"></pre>
    </div>


    Select all metadata files:
    <input type="file" id="filesInput" multiple >
    <output id="list"></output>

    <!-- BRYTHON SCRIPT /////////////////////////////////////////////////////////////////////// -->
    <script type="text/python" id="fileToMsg">
        from browser import document, alert
        import re
        # bind event 'click' on button to function echo

        def echo(ev):
            # message = document["zone"].value
            # message = message * 5
            message = document["fileDisplayArea"].innerText
            # file_content = fileContent
            message = message.split()
            size = len(message[-1])
            message = "Python read your file, the last word is: '" + str(message[-1]) + \
                      "'\nand it is " + str(size) + " characters long"
            alert(message)

        document["mybutton"].bind("click", echo)
    </script>

    <!-- BRYTHON SCRIPT /////////////////////////////////////////////////////////////////////// -->
    <script type="text/python" id="dbToMsg">
        from browser import window, document, alert
        import json
        def echo_db(ev):
            # window.connection.runSql("SELECT * FROM Student").then(window.function(result) {answer = result})
            query_text =  document["query_zone"].value
            window.sqlQuery(query_text)

        def getResult(result):
            query_result = json.loads(result.detail)
            text_result = ''
            for x in query_result:
                for key in x:
                    text_result = text_result + str(x[key]) + ', '
                text_result = text_result + '\n'
            document["queryDisplayArea"].innerText = text_result

        document["action_button"].bind("click", echo_db)
        document.bind("finishedQuery", getResult)
    </script>
    <!-- BRYTHON SCRIPT /////////////////////////////////////////////////////////////////////// -->
    <script type="text/python" id="fileToDb">
        from browser import window, document, alert
        import datetime, json

        def cmp_datetime(a_datetime, b_datetime):
            if a_datetime < b_datetime:
                return -1
            elif a_datetime > b_datetime:
                return 1
            else:
                return 0

        def readStudentMeta(result):
            # files = json.loads(result.detail)
            lines = result.detail
            window.console.log(lines)
            alert('asd')

            '''
            file = result.detail
            lines = file.split('\n')
            window.console.log(lines[0])

            for line in lines[1:]:
                record = line.split("\t")
                global_learner_id = record[1]
                course_id = record[2]
                time = datetime.datetime.strptime(record[3], "%Y-%m-%d %H:%M:%S")
                course_learner_id = course_id + "_" + global_learner_id

                if cmp_datetime(course_metadata_map["end_time"], time):
                    enrolled_learner_set.add(global_learner_id)

                    array = [global_learner_id, course_id, course_learner_id]
                    learner_index_record.append(array)

                    course_learner_map[global_learner_id] = course_learner_id
                    learner_enrollment_time_map[global_learner_id] = time
            alert("The number of enrolled learners is: ", str(len(enrolled_learner_set)), "\n")
            '''

        document.bind("studentMetaReader", readStudentMeta)
    </script>
    <!-- BRYTHON SCRIPT /////////////////////////////////////////////////////////////////////// -->

    <link href="style/main.css " rel="stylesheet " type="text/css " />
</body>

</html>